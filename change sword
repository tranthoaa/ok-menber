local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")

local player = Players.LocalPlayer
local CommF = ReplicatedStorage.Remotes.CommF_
local placeId = game.PlaceId
local TARGET_MASTERY = 350
local RETRY_TIME = 30 -- 30 gi√¢y

-- ===== L·∫•y mastery =====
local function getInventory()
    local inv = {}
    pcall(function()
        inv = CommF:InvokeServer("getInventory") or {}
    end)
    return inv
end

local function getMastery(name)
    for _, item in pairs(getInventory()) do
        if item.Type == "Sword" and item.Name:lower():find(name:lower()) then
            return tonumber(item.Mastery) or 0
        end
    end
    return 0
end

-- ===== Hop server =====
local function HopLowPlayer()
    local Joined = {}
    local url = "https://games.roblox.com/v1/games/" .. placeId .. "/servers/Public?sortOrder=Asc&limit=50"

    local success, result = pcall(function()
        return HttpService:JSONDecode(game:HttpGet(url))
    end)

    if not success or not result or not result.data then
        warn("‚ùå L·∫•y server list th·∫•t b·∫°i ‚Üí teleport fallback")
        TeleportService:Teleport(placeId, player)
        return
    end

    local bestServer
    local lowest = math.huge

    for _, s in pairs(result.data) do
        if not Joined[s.id] and s.playing < s.maxPlayers then
            if s.playing < lowest then
                lowest = s.playing
                bestServer = s
            end
        end
    end

    if bestServer then
        Joined[bestServer.id] = true
        print("üåê Hop server:", bestServer.id, "s·ªë ng∆∞·ªùi:", bestServer.playing)
        TeleportService:TeleportToPlaceInstance(placeId, bestServer.id, player)
    else
        print("‚ö†Ô∏è Kh√¥ng t√¨m ƒë∆∞·ª£c server tr·ªëng, teleport fallback")
        TeleportService:Teleport(placeId, player)
    end
end

-- ===== V√íNG L·∫∂P HOP SERVER 30s =====
while true do
    local tushitaMastery = getMastery("Tushita")
    local yamaMastery = getMastery("Yama")

    print("üìä Tushita:", tushitaMastery, "| Yama:", yamaMastery)

    if tushitaMastery >= TARGET_MASTERY and yamaMastery >= TARGET_MASTERY then
        print("‚úÖ C·∫£ 2 mastery ‚â• 350 ‚Üí Hop server")
        task.wait(10) -- delay 10s tr∆∞·ªõc hop
        HopLowPlayer()
        break -- tho√°t v√≤ng l·∫∑p sau khi hop
    else
        print("‚è≥ Ch∆∞a ƒë·ªß mastery ‚Üí th·ª≠ l·∫°i sau 30 gi√¢y")
        task.wait(RETRY_TIME)
    end
end
