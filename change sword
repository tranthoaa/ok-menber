local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")

local player = Players.LocalPlayer
local CommF = ReplicatedStorage.Remotes.CommF_

-- ===== CHECK ƒêANG C·∫¶M KI·∫æM =====
local function isEquipped(name)
    if not player.Character then return false end
    for _, v in pairs(player.Character:GetChildren()) do
        if v:IsA("Tool") and v.Name:lower():find(name:lower()) then
            return true
        end
    end
    return false
end

-- ===== EQUIP KI·∫æM B·∫∞NG SERVER =====
local function equipSword(name)
    if isEquipped(name) then return true end
    pcall(function()
        CommF:InvokeServer("EquipWeapon", name)
    end)
    task.wait(0.3)
    return isEquipped(name)
end

-- ===== INVENTORY & MASTERY =====
local function getInventory()
    local inv = {}
    pcall(function()
        inv = CommF:InvokeServer("getInventory") or {}
    end)
    return inv
end

local function getMastery(name)
    for _, item in pairs(getInventory()) do
        if item.Type == "Sword" and item.Name:lower():find(name:lower()) then
            return tonumber(item.Mastery) or 0
        end
    end
    return 0
end

-- ===== AUTO FARM + HOP SERVER =====
local TARGET_MASTERY = 350

local function autoFarmHop()
    local hasTushita, hasYama = false, false

    -- check inventory
    for _, item in pairs(getInventory()) do
        if item.Type == "Sword" then
            if item.Name:lower():find("tushita") then hasTushita = true end
            if item.Name:lower():find("yama") then hasYama = true end
        end
    end

    if not hasTushita then warn("‚ùå Kh√¥ng c√≥ Tushita") return end
    if not hasYama then warn("‚ùå Kh√¥ng c√≥ Yama") return end

    -- ===== STEP 1: EQUIP TUSHITA =====
    if not isEquipped("Tushita") then
        print("‚öîÔ∏è Trang b·ªã Tushita...")
        equipSword("Tushita")
    end

    -- ===== STEP 2: FARM TUSHITA MASTERY =====
    while getMastery("Tushita") < TARGET_MASTERY do
        print("‚è≥ Ch·ªù Tushita ƒë·∫°t mastery 350:", getMastery("Tushita"))
        task.wait(3)
    end
    print("‚úÖ Tushita ƒë·∫°t mastery 350")

    -- ===== STEP 3: EQUIP YAMA =====
    if not isEquipped("Yama") then
        print("‚öîÔ∏è Trang b·ªã Yama...")
        equipSword("Yama")
    end

    -- ===== STEP 4: FARM YAMA MASTERY =====
    while getMastery("Yama") < TARGET_MASTERY do
        print("‚è≥ Ch·ªù Yama ƒë·∫°t mastery 350:", getMastery("Yama"))
        task.wait(3)
    end
    print("‚úÖ Yama ƒë·∫°t mastery 350")

    -- ===== STEP 5: HOP SERVER =====
    print("üåê ƒê·ªß ƒëi·ªÅu ki·ªán ‚Üí Hop server m·ªõi...")
    local placeId = game.PlaceId
    TeleportService:Teleport(placeId, player)
end

-- RUN AUTO
local HttpService = game:GetService("HttpService")
local TS = game:GetService("TeleportService")
local Players = game:GetService("Players")

local plr = Players.LocalPlayer
local placeId = game.PlaceId

-- table l∆∞u server ƒë√£ join (tr√°nh join l·∫°i)
local Joined = {}

-- ===== H√ÄM HOP SERVER =====
local function HopLowPlayer()
    -- URL l·∫•y server list
    local url = "https://games.roblox.com/v1/games/" .. placeId .. "/servers/Public?sortOrder=Asc&limit=50"

    local success, result = pcall(function()
        return HttpService:JSONDecode(game:HttpGet(url))
    end)

    if not success or not result or not result.data then
        warn("‚ùå L·∫•y server list th·∫•t b·∫°i ‚Üí teleport fallback")
        TS:Teleport(placeId, plr)
        return
    end

    local bestServer
    local lowest = math.huge

    for _, s in pairs(result.data) do
        if not Joined[s.id] and s.playing < s.maxPlayers then
            if s.playing < lowest then
                lowest = s.playing
                bestServer = s
            end
        end
    end

    if bestServer then
        Joined[bestServer.id] = true
        print("üåê Hop server:", bestServer.id, "s·ªë ng∆∞·ªùi:", bestServer.playing)
        TS:TeleportToPlaceInstance(placeId, bestServer.id, plr)
    else
        -- fallback nhanh
        print("‚ö†Ô∏è Kh√¥ng t√¨m ƒë∆∞·ª£c server tr·ªëng, teleport fallback")
        TS:Teleport(placeId, plr)
    end
end

-- ===== DELAY 10 GI√ÇY =====
print("‚è≥ Ch·ªù 10 gi√¢y tr∆∞·ªõc khi hop server...")
task.wait(10)

HopLowPlayer()

